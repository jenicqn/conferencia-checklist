<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // 1) PREENCHA:
  const SUPABASE_URL = "https://xmhoawlseijujgnhidvq.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaG9hd2xzZWlqdWpnbmhpZHZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwOTI0MTUsImV4cCI6MjA3MjY2ODQxNX0.kp3FkAFTd_4ln3JvW3wdneKQ0QkIpKBFI5_TXUD5EZk";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // refs UI
  const els = {
    location: document.getElementById('location'),
    date:     document.getElementById('date'),
    turno:    document.getElementById('turno'),
    funcao:   document.getElementById('funcao'),
    key:      document.getElementById('key'),
    bar:      document.getElementById('bar'),
    summary:  document.getElementById('summary'),
    grid:     document.getElementById('grid'),
    updated:  document.getElementById('updated'),
  };

  // default hoje
  const today = new Date().toISOString().slice(0,10);
  if (els.date) els.date.value = today;

  const keyObj = () => ({
    location: els.location.value,
    day: els.date.value || today,
    turno: els.turno.value,
    funcao: els.funcao.value
  });
  const keyText = k => `${k.location} / ${k.day} / ${k.turno} / ${k.funcao}`;

  let lastUpdatedAt = null;   // evita re-render desnecessário
  let timer = null;           // intervalo do polling
  const POLL_MS = 3000;       // ajuste se quiser (3000 = 3s)

  async function fetchState(k){
    const { data, error } = await supabase
      .from('checklist_states')
      .select('*')
      .eq('location', k.location)
      .eq('day', k.day)
      .eq('turno', k.turno)
      .eq('funcao', k.funcao)
      .maybeSingle();

    if (error && error.details !== 'The result contains 0 rows') {
      console.warn('select error:', error.message);
      return null;
    }
    return data || null;
  }

  function render(row){
    const data = row || {};
    const items = data.items || {};
    const keys = Object.keys(items);

    const done = keys.filter(k=>{
      const it = items[k];
      return (typeof it === 'object') ? !!it.sent : !!it;
    }).length;

    const total = keys.length;
    const pct = total ? Math.round(done*100/total) : (data.progress ?? 0);

    els.bar.style.width = pct + '%';
    els.summary.textContent = total ? `${done}/${total} concluídos • ${pct}%` : 'Aguardando itens…';
    els.updated.textContent = data.updated_at ? new Date(data.updated_at).toLocaleString('pt-BR') : '—';

    els.grid.innerHTML = total
      ? keys.sort().map(k=>{
          const it = items[k];
          const ok = (typeof it === 'object') ? !!it.sent : !!it;
          const label = (typeof it === 'object' && it.text) ? it.text : k.replaceAll('_',' ');
          return `<div class="row"><div>${label}</div><div class="${ok?'ok':'no'}">${ok?'OK':'Pendente'}</div></div>`;
        }).join('')
      : '<div class="muted">Sem itens enviados ainda.</div>';
  }

  async function tick(){
    const k = keyObj();
    els.key.textContent = keyText(k);
    const row = await fetchState(k);
    const currentUpdated = row?.updated_at || null;

    // só re-renderiza se mudou
    if (currentUpdated !== lastUpdatedAt) {
      lastUpdatedAt = currentUpdated;
      render(row);
    }
  }

  function startPolling(){
    if (timer) clearInterval(timer);
    tick(); // roda já
    timer = setInterval(tick, POLL_MS);
  }

  ['change','input'].forEach(evt=>{
    els.location.addEventListener(evt, startPolling);
    els.date.addEventListener(evt, startPolling);
    els.turno.addEventListener(evt, startPolling);
    els.funcao.addEventListener(evt, startPolling);
  });

  // inicia
  startPolling();
</script>
